# üöÄ Guide de D√©ploiement Serveur - SaaS Data Platform

Guide complet pour d√©ployer la plateforme SaaS Data Platform sur un serveur sans IP fixe en utilisant les ports √† partir de 9000.

## üìã Pr√©requis

### Serveur
- **OS** : Ubuntu 20.04+ / CentOS 8+ / Debian 11+
- **RAM** : 8 GB minimum (16 GB recommand√©)
- **Stockage** : 50 GB minimum
- **CPU** : 4 c≈ìurs minimum
- **R√©seau** : Acc√®s internet avec ports ouverts

### Logiciels
- Docker 20.10+
- Docker Compose 2.0+
- Git
- Curl
- Netstat (pour v√©rifier les ports)

## üîß Installation des Pr√©requis

### Ubuntu/Debian
```bash
# Mise √† jour du syst√®me
sudo apt update && sudo apt upgrade -y

# Installation de Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Ajouter l'utilisateur au groupe docker
sudo usermod -aG docker $USER

# Installation de Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Installation des outils
sudo apt install -y git curl net-tools

# Red√©marrer la session pour les groupes
newgrp docker
```

### CentOS/RHEL
```bash
# Installation de Docker
sudo yum install -y docker docker-compose git curl net-tools
sudo systemctl start docker
sudo systemctl enable docker

# Ajouter l'utilisateur au groupe docker
sudo usermod -aG docker $USER
newgrp docker
```

## üì• D√©ploiement

### 1. T√©l√©chargement du Projet
```bash
# Cloner le projet
git clone <repository-url>
cd saas

# Ou t√©l√©charger l'archive
wget <archive-url>
tar -xzf saas-platform.tar.gz
cd saas
```

### 2. Configuration
```bash
# Copier le fichier de configuration serveur
cp env.server.example .env

# √âditer la configuration
nano .env
```

**Configuration importante √† modifier dans `.env` :**
```env
# Mots de passe s√©curis√©s
POSTGRES_PASSWORD=your_secure_password_here
SECRET_KEY=your_very_secure_secret_key_here
GRAFANA_ADMIN_PASSWORD=your_secure_admin_password

# Configuration serveur
BASE_URL=http://[IP_DE_VOTRE_SERVEUR]
```

### 3. D√©ploiement Automatique
```bash
# Rendre le script ex√©cutable
chmod +x deploy-server.sh

# D√©ploiement complet
./deploy-server.sh deploy
```

### 4. D√©ploiement Manuel
```bash
# Construction des images
docker-compose -f docker-compose.server.yml build

# D√©marrage des services
docker-compose -f docker-compose.server.yml up -d

# V√©rification du statut
docker-compose -f docker-compose.server.yml ps
```

## üåê Acc√®s aux Services

### URLs Principales
| Service | URL | Port Direct |
|---------|-----|-------------|
| **Dashboard** | `http://[IP_SERVEUR]/dashboard/` | 10000 |
| **API Docs** | `http://[IP_SERVEUR]/api/docs` | 10000 |
| **NiFi** | `http://[IP_SERVEUR]/nifi/` | 10080 |
| **Grafana** | `http://[IP_SERVEUR]/grafana/` | 10300 |
| **Prometheus** | `http://[IP_SERVEUR]/prometheus/` | 10090 |

### Services de Traitement
| Service | Port | Description |
|---------|------|-------------|
| DBT Service | 10001 | Transformation de donn√©es |
| R√©conciliation | 10002 | Matching et d√©duplication |
| Contr√¥le Qualit√© | 10003 | Validation et anomalies |
| RCA Service | 10004 | Analyse des causes racines |

### Base de Donn√©es
| Service | Port | Description |
|---------|------|-------------|
| PostgreSQL | 10543 | Data warehouse |
| Redis | 10637 | Cache et sessions |

## üîí Configuration S√©curis√©e

### 1. Pare-feu (UFW)
```bash
# Activer UFW
sudo ufw enable

# Ouvrir les ports n√©cessaires
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 10000:10004/tcp
sudo ufw allow 10080/tcp
sudo ufw allow 10090/tcp
sudo ufw allow 10300/tcp
sudo ufw allow 10543/tcp
sudo ufw allow 10637/tcp

# V√©rifier le statut
sudo ufw status
```

### 2. SSL/TLS (Optionnel)
```bash
# Installation de Certbot
sudo apt install certbot python3-certbot-nginx

# G√©n√©ration du certificat (remplacer par votre domaine)
sudo certbot --nginx -d your-domain.com

# Configuration Nginx SSL dans nginx/nginx.server.conf
```

### 3. Mots de Passe S√©curis√©s
```bash
# G√©n√©rer des mots de passe s√©curis√©s
openssl rand -base64 32  # Pour SECRET_KEY
openssl rand -base64 16  # Pour POSTGRES_PASSWORD
```

## üìä Monitoring et Maintenance

### 1. V√©rification de Sant√©
```bash
# Script automatique
./deploy-server.sh health

# Manuel
curl http://[IP_SERVEUR]/health
```

### 2. Logs
```bash
# Tous les services
./deploy-server.sh logs

# Service sp√©cifique
docker-compose -f docker-compose.server.yml logs -f api-dashboard-service
```

### 3. Sauvegarde
```bash
# Sauvegarde base de donn√©es
docker-compose -f docker-compose.server.yml exec warehouse-service pg_dump -U warehouse_user data_warehouse > backup_$(date +%Y%m%d_%H%M%S).sql

# Sauvegarde volumes
docker run --rm -v saas_postgres-data:/data -v $(pwd):/backup alpine tar czf /backup/postgres-backup.tar.gz /data
```

### 4. Mise √† Jour
```bash
# Arr√™ter les services
./deploy-server.sh stop

# Mettre √† jour le code
git pull

# Red√©ployer
./deploy-server.sh deploy
```

## üîß Commandes Utiles

### Gestion des Services
```bash
# D√©marrage
./deploy-server.sh deploy

# Arr√™t
./deploy-server.sh stop

# Red√©marrage
./deploy-server.sh restart

# Logs
./deploy-server.sh logs

# Sant√©
./deploy-server.sh health

# URLs
./deploy-server.sh urls
```

### Docker Compose Direct
```bash
# Statut
docker-compose -f docker-compose.server.yml ps

# Logs sp√©cifiques
docker-compose -f docker-compose.server.yml logs -f [service-name]

# Red√©marrage d'un service
docker-compose -f docker-compose.server.yml restart [service-name]

# Shell dans un container
docker-compose -f docker-compose.server.yml exec [service-name] /bin/bash
```

### Maintenance
```bash
# Nettoyage complet
./deploy-server.sh clean

# Nettoyage Docker
docker system prune -f

# V√©rification des ports
netstat -tulpn | grep -E ':(80|10000|10001|10002|10003|10004|10080|10090|10300|10543|10637)'
```

## üåç Acc√®s Externe

### 1. Sans Domaine (IP Publique)
```bash
# Obtenir l'IP publique
curl ifconfig.me

# Acc√®s via IP
http://[IP_PUBLIQUE]/dashboard/
```

### 2. Avec Domaine Dynamique
```bash
# Configuration No-IP ou DuckDNS
# Mise √† jour automatique de l'IP

# Acc√®s via domaine
http://your-domain.duckdns.org/dashboard/
```

### 3. Reverse Proxy Externe
```bash
# Configuration Nginx/Apache externe
# Redirection vers les ports internes

# Exemple Nginx externe
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## üö® D√©pannage

### Probl√®mes Courants

#### 1. Ports Occup√©s
```bash
# V√©rifier les ports utilis√©s
netstat -tulpn | grep :9000

# Arr√™ter le processus
sudo kill -9 [PID]

# Ou changer le port dans docker-compose.server.yml
```

#### 2. Services Non D√©marr√©s
```bash
# V√©rifier les logs
docker-compose -f docker-compose.server.yml logs [service-name]

# Red√©marrer le service
docker-compose -f docker-compose.server.yml restart [service-name]

# V√©rifier les ressources
docker stats
```

#### 3. Base de Donn√©es Non Accessible
```bash
# V√©rifier la connexion
docker-compose -f docker-compose.server.yml exec warehouse-service pg_isready -U warehouse_user -d data_warehouse

# V√©rifier les logs
docker-compose -f docker-compose.server.yml logs warehouse-service

# Red√©marrer la base
docker-compose -f docker-compose.server.yml restart warehouse-service
```

#### 4. Probl√®mes de M√©moire
```bash
# V√©rifier l'utilisation m√©moire
free -h
docker stats

# Limiter les ressources dans docker-compose.server.yml
services:
  api-dashboard-service:
    deploy:
      resources:
        limits:
          memory: 1G
```

## üìà Optimisation Performance

### 1. Configuration Serveur
```bash
# Augmenter les limites syst√®me
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# Optimiser Docker
sudo nano /etc/docker/daemon.json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

### 2. Configuration Base de Donn√©es
```sql
-- Optimisations PostgreSQL
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
ALTER SYSTEM SET checkpoint_completion_target = 0.9;
ALTER SYSTEM SET wal_buffers = '16MB';
ALTER SYSTEM SET default_statistics_target = 100;
```

### 3. Monitoring Avanc√©
```bash
# Installation de monitoring syst√®me
sudo apt install htop iotop nethogs

# Surveillance en temps r√©el
htop
iotop
nethogs
```

## üîÑ Sauvegarde et Restauration

### Script de Sauvegarde Automatique
```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups"

# Cr√©er le r√©pertoire de sauvegarde
mkdir -p $BACKUP_DIR

# Sauvegarde base de donn√©es
docker-compose -f docker-compose.server.yml exec -T warehouse-service pg_dump -U warehouse_user data_warehouse > $BACKUP_DIR/db_backup_$DATE.sql

# Sauvegarde volumes
docker run --rm -v saas_postgres-data:/data -v $BACKUP_DIR:/backup alpine tar czf /backup/volumes_backup_$DATE.tar.gz /data

# Nettoyage des anciennes sauvegardes (garde 7 jours)
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "Sauvegarde termin√©e: $DATE"
```

### Cron Job pour Sauvegarde Automatique
```bash
# √âditer le crontab
crontab -e

# Ajouter la ligne pour sauvegarde quotidienne √† 2h du matin
0 2 * * * /path/to/backup.sh >> /var/log/backup.log 2>&1
```

## üìû Support

### Logs Importants
- **Application** : `docker-compose -f docker-compose.server.yml logs -f`
- **Syst√®me** : `/var/log/syslog`
- **Nginx** : `docker-compose -f docker-compose.server.yml logs nginx`
- **Base de donn√©es** : `docker-compose -f docker-compose.server.yml logs warehouse-service`

### Informations de Debug
```bash
# Collecter les informations syst√®me
./deploy-server.sh urls > server_info.txt
docker-compose -f docker-compose.server.yml ps >> server_info.txt
docker stats --no-stream >> server_info.txt
free -h >> server_info.txt
df -h >> server_info.txt
```

---

**üéØ Votre plateforme SaaS Data Platform est maintenant d√©ploy√©e et accessible sur votre serveur !**

**üìã Prochaines √©tapes :**
1. Tester l'acc√®s aux services via les URLs fournies
2. Configurer les mots de passe s√©curis√©s
3. Mettre en place les sauvegardes automatiques
4. Configurer le monitoring avanc√©
5. Optimiser selon vos besoins sp√©cifiques
